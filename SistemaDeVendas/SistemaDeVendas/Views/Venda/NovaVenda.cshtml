@model SistemaDeVendas.Models.VendaModel

@{
    var clientes = ViewBag.Clientes as List<SistemaDeVendas.Models.Cliente>;
    var produtos = ViewBag.Produtos as List<SistemaDeVendas.Models.Produto>;
}

<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Nova Venda</h1>

    <form asp-action="NovaVenda" method="post" id="formVenda">

        <div class="form-group">
            <label>Cliente</label>
            <select asp-for="Id_Cliente" class="form-control" required>
                <option value="">Selecione</option>
                @foreach (var cliente in clientes)
                {
                    <option value="@cliente.Id">@cliente.Nome @cliente.Sobrenome</option>
                }
            </select>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <label>Produto</label>
                <select id="produtoSelect" class="form-control">
                    <option value="">Selecione um produto</option>
                    @foreach (var produto in produtos)
                    {
                        <option value="@produto.Id"
                                data-preco="@((produto.Preco_Unitario ?? 0).ToString("F2", System.Globalization.CultureInfo.InvariantCulture))">
                            @produto.Nome
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-primary" onclick="adicionarProduto()">
                    Adicionar
                </button>
            </div>
        </div>

        <table class="table table-bordered mt-4">
            <thead class="text-center">
                <tr>
                    <th>Produto</th>
                    <th style="width: 120px">Preço</th>
                    <th style="width: 120px">Qtd</th>
                    <th style="width: 140px">Subtotal</th>
                    <th style="width: 60px"></th>
                </tr>
            </thead>
            <tbody id="itensVenda"></tbody>
        </table>

        <div class="form-group text-right">
            <label>Total</label>
            <input type="text"
                   id="Total"
                   class="form-control font-weight-bold text-right"
                   readonly
                   value="R$ 0,00" />
        </div>

        <button type="submit" class="btn btn-success mt-3">
            Finalizar Venda
        </button>

    </form>
</div>

<script>
    function adicionarProduto() {
        const select = document.getElementById("produtoSelect");
        const produtoId = select.value;

        if (!produtoId) return;

        if (document.getElementById("produto-" + produtoId)) {
            alert("Produto já adicionado");
            return;
        }

        const produtoNome = select.options[select.selectedIndex].text;
        const preco = parseFloat(select.options[select.selectedIndex].dataset.preco);

        const tbody = document.getElementById("itensVenda");

        const tr = document.createElement("tr");
        tr.id = "produto-" + produtoId;
        tr.classList.add("item-venda");

        tr.innerHTML = `
            <td>
                ${produtoNome}
                <input type="hidden" name="ProdutosIds" value="${produtoId}" />
            </td>
            <td>
                <input type="number"
                       class="form-control preco-produto"
                       value="${preco.toFixed(2)}"
                       step="0.01"
                       readonly />
            </td>
            <td>
                <input type="number"
                       name="Quantidades"
                       class="form-control quantidade-produto"
                       value="1"
                       min="1" />
            </td>
            <td class="subtotal">R$ 0,00</td>
            <td class="text-center">
                <button type="button"
                        class="btn btn-danger btn-sm"
                        onclick="removerProduto('${tr.id}')">
                    X
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        tr.querySelector(".quantidade-produto")
          .addEventListener("input", atualizarTotal);

        atualizarTotal();
    }

    function removerProduto(id) {
        document.getElementById(id).remove();
        atualizarTotal();
    }

    function atualizarTotal() {
        let total = 0;

        document.querySelectorAll(".item-venda").forEach(item => {
            const preco = parseFloat(item.querySelector(".preco-produto").value) || 0;
            const qtd = parseInt(item.querySelector(".quantidade-produto").value) || 0;
            const subtotal = preco * qtd;

            total += subtotal;

            item.querySelector(".subtotal").innerText =
                subtotal.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL"
                });
        });

        document.getElementById("Total").value =
            total.toLocaleString("pt-BR", {
                style: "currency",
                currency: "BRL"
            });
    }
</script>
